<div class="header">
  <a mat-icon-button routerLink="/facsimiles">
    <mat-icon>west</mat-icon>
  </a>
  <h1>Create facsimile collections from publications</h1>
</div>

<div class="content">
  <p>Select a publication collection and configure the facsimile collection settings. A new facsimile collection will be created for each publication in the selected collection.</p>

  <form [formGroup]="form" (ngSubmit)="createFacsimileCollections()" class="form">
    <div class="form-section">
      <h2>Collection selection</h2>
      <mat-form-field [subscriptSizing]="'dynamic'" class="full-width">
        <mat-label>Publication collection</mat-label>
        <mat-select formControlName="publicationCollectionId" required>
          @for (collection of (publicationCollections$ | async); track collection.id) {
            <mat-option [value]="collection.id">
              {{ collection.name }} (ID: {{ collection.id }})
            </mat-option>
          }
        </mat-select>
        @if (form.get('publicationCollectionId')?.hasError('required')) {
          <mat-error>Please select a publication collection.</mat-error>
        }
      </mat-form-field>
    </div>

    <div class="form-section">
      <h2>Facsimile collection settings</h2>
      
      <div class="form-row">
        <mat-form-field [subscriptSizing]="'dynamic'">
          <mat-label>Number of pages</mat-label>
          <input matInput type="number" formControlName="numberOfPages" min="1" required>
          @if (form.get('numberOfPages')?.hasError('required')) {
            <mat-error>Number of pages is required.</mat-error>
          }
          @if (form.get('numberOfPages')?.hasError('min')) {
            <mat-error>Number of pages must be at least 1.</mat-error>
          }
        </mat-form-field>

        <mat-form-field [subscriptSizing]="'dynamic'">
          <mat-label>Start page number</mat-label>
          <input matInput type="number" formControlName="startPageNumber" min="0" required>
          @if (form.get('startPageNumber')?.hasError('required')) {
            <mat-error>Start page number is required.</mat-error>
          }
          @if (form.get('startPageNumber')?.hasError('min')) {
            <mat-error>Start page number must be at least 0.</mat-error>
          }
        </mat-form-field>
      </div>

      <mat-form-field [subscriptSizing]="'dynamic'" class="full-width">
        <mat-label>Title source</mat-label>
        <mat-select formControlName="titleSource" required>
          <mat-option value="publication">Publication name</mat-option>
          <mat-option value="manuscript">First manuscript name</mat-option>
        </mat-select>
        <mat-hint>Choose whether to use the publication name or the first manuscript name as the facsimile collection title.</mat-hint>
      </mat-form-field>

      <mat-form-field [subscriptSizing]="'dynamic'" class="full-width">
        <mat-label>Description</mat-label>
        <input matInput type="text" formControlName="description">
      </mat-form-field>
    </div>

    <div class="form-actions">
      <button matButton type="button" (click)="navToFacsimileCollections()" [disabled]="isProcessing">
        Cancel
      </button>
      <button matButton="filled" type="submit" [disabled]="!form.valid || isProcessing">
        <mat-icon>add</mat-icon>
        Create facsimile collections
      </button>
    </div>
  </form>

  @if (isProcessing) {
    <div class="processing-section">
      <loading-spinner></loading-spinner>
      <p>{{ progressMessage }}</p>
    </div>
  }

  @if (creationSummary) {
    <div class="results-section">     
      <div class="results-summary">
        <div class="result-item success">
          <mat-icon>check_circle</mat-icon>
          <span>Successfully created: {{ creationSummary.successful }} / {{ creationSummary.total }}</span>
        </div>
        @if (creationSummary.failed > 0) {
          <div class="result-item error">
            <mat-icon>error</mat-icon>
            <span>Failed: {{ creationSummary.failed }} / {{ creationSummary.total }}</span>
          </div>
        }
      </div>

      @if (creationSummary.failed > 0) {
        <div class="failed-items">
          <h3>Failed publications:</h3>
          <ul>
            @for (result of creationSummary.results; track result.publicationId) {
              @if (!result.success) {
                <li>
                  <strong>{{ result.publicationName }}</strong> (ID: {{ result.publicationId }})
                  <br>
                  <span class="error-message">{{ result.error }}</span>
                </li>
              }
            }
          </ul>
        </div>
      }

      <!--
      @if (creationSummary.successful > 0) {
        <div class="success-items">
          <h3>Successfully created:</h3>
          <ul>
            @for (result of creationSummary.results; track result.publicationId) {
              @if (result.success) {
                <li>
                  <strong>{{ result.publicationName }}</strong> → 
                  <em>{{ result.facsimileTitle }}</em> (ID: {{ result.facsimileId }})
                </li>
              }
            }
          </ul>
        </div>
      }
      -->

      <div class="results-actions">
        <button matButton="filled" (click)="navToFacsimileCollections()">
          <mat-icon>arrow_back</mat-icon>
          Back to facsimile collections
        </button>
      </div>
    </div>
  }
</div>
