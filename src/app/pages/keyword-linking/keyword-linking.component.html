@let currentCollectionId = selectedCollectionId$ | async;
@let currentPublicationId = selectedPublicationId();
@let currentPublication = selectedPublication();
@let publicationsList = publications$ | async;
@let publicationsLoading = showLoadingPublications$ | async;
@let linkedKeywordsList = linkedKeywords$ | async;
@let keywordsLoading = showLoadingKeywords$ | async;

<div class="header">
  <h1>Keyword linking to publications</h1>
  <p>Connect keywords to publications. Select a collection to view its publications and manage their keyword associations.</p>
</div>

@if (!projectName()) {
  <p>Please select a project.</p>
} @else {
  <!-- Collection Selection -->
  <div class="collection-selection">
    <mat-form-field [subscriptSizing]="'dynamic'">
      <mat-label>Publication collection</mat-label>
      <mat-select [formControl]="collectionControl">
        @for (collection of collections$ | async; track collection.id) {
          <mat-option [value]="collection.id">
            {{ collection.name }} (ID: {{ collection.id }})
          </mat-option>
        }
      </mat-select>
    </mat-form-field>
  </div>

  <!-- Main content area -->
  @if (currentCollectionId && !publicationsLoading) {
    <div class="panel-wrapper">
      <!-- Publications panel (left column) -->
      <div class="publications-panel">
        <publication-keyword-table
              [class.hide]="publicationsLoading"
              [publications]="publicationsList"
              [selectedId]="currentPublicationId"
              (rowClick)="selectPublication($event)"
        ></publication-keyword-table>
      </div>

      <!-- Keywords panel (right column) -->
      @if (currentPublicationId) {
        <div class="keywords-panel">
          <h3>Linked keywords
            @if (!keywordsLoading && linkedKeywordsList !== null) {
              ({{ linkedKeywordsList?.length }}) – {{ currentPublication?.name || '' }}
            }
          </h3>

          <!-- Keyword search field -->
          <div class="keyword-search-section">
            <mat-form-field class="search-field">
              <mat-label>Link a keyword</mat-label>
              <input type="text"
                    matInput
                    [formControl]="keywordSearchControl"
                    [matAutocomplete]="keywordAuto"
                    placeholder="Search keywords by name or create a new one…"
              >
              <!-- Keyword autocomplete -->
              <mat-autocomplete #keywordAuto="matAutocomplete" 
                    [displayWith]="displayKeyword"
                    (optionSelected)="linkOrCreateKeyword($event)"
              >
                @for (keyword of filteredKeywords$ | async; track keyword.id) {
                  <mat-option [value]="keyword">
                    <div class="keyword-option">
                      <mat-icon aria-hidden="true">label</mat-icon>
                      <span class="k-name">{{ keyword.name }}</span>
                      @if (keyword.category) {
                        <span class="k-category">[{{ keyword.category }}]</span>
                      }
                    </div>
                  </mat-option>
                }
                @if (keywordSearchControl.value) {
                  <mat-option [value]="null">
                    <div class="create-new-option">
                      <mat-icon aria-hidden="true">add</mat-icon>
                      Create new keyword: »{{ keywordSearchControl.value }}»
                    </div>
                  </mat-option>
                }
              </mat-autocomplete>
              <!-- Clear keyword search button -->
              @if (!(keywordSearchControl.value | isEmptyString)) {
                <button matIconButton
                      matSuffix
                      (click)="keywordSearchControl.setValue('')"
                      aria-label="Clear keyword search term"
                >
                  <mat-icon>close</mat-icon>
                </button>
              } @else {
                <mat-icon matSuffix>flowchart</mat-icon>
              }
            </mat-form-field>
          </div>

          @if (!keywordsLoading && linkedKeywordsList !== null) {
            <!-- Linked keywords table -->
            <table mat-table
                  [dataSource]="linkedKeywordsList"
                  class="mat-elevation-z1 keywords-table"
            >
              <!-- Keyword name column -->
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef>Keyword</th>
                <td mat-cell *matCellDef="let keyword">{{ keyword.name }}</td>
              </ng-container>

              <!-- Category column -->
              <ng-container matColumnDef="category">
                <th mat-header-cell *matHeaderCellDef>Category</th>
                <td mat-cell *matCellDef="let keyword">
                    @if (keyword.category) {
                    <span>{{ keyword.category }}</span>
                    } @else {
                      –
                    }
                </td>
              </ng-container>

              <!-- Actions column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let keyword">
                  <div class="row-actions">
                    <button matIconButton
                          (click)="removeKeywordFromPublication(keyword)"
                          aria-label="Remove keyword from publication"
                    >
                      <mat-icon>label_off</mat-icon>
                    </button>
                  </div>
                </td>
              </ng-container>

              <!-- header + data rows -->
              <tr mat-header-row *matHeaderRowDef="keywordColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: keywordColumns"></tr>

              <!-- no data row -->
              <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell" [attr.colspan]="keywordColumns.length">
                  <div class="center-row">
                    No keywords linked to publication.
                  </div>
                </td>
              </tr>
            </table>
          } @else {
            <div class="loading-keywords">
              <loading-spinner/>
            </div>
          }
        </div>
      } @else {
        <!-- No publication selected -->
        <div class="no-selection">
          <mat-icon aria-hidden="true">info</mat-icon>
          <p>Select a publication from the list to view and manage its linked keywords.</p>
        </div>
      }
    </div>
  } @else if (currentCollectionId && publicationsLoading) {
    <loading-spinner [overlay]="true"/>
  }
}
