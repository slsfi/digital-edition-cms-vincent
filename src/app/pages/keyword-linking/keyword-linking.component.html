<div class="header">
  <h1>Keyword linking to publications</h1>
  <p>Connect keywords to publications. Select a collection to view its publications and manage their keyword associations.</p>
</div>

@if (!projectName()) {
  <p>Please select a project.</p>
} @else {
  <!-- Collection Selection -->
  <div class="collection-selection">
    <mat-form-field [subscriptSizing]="'dynamic'">
      <mat-label>Publication collection</mat-label>
      <mat-select [formControl]="collectionControl">
        @for (collection of collections$ | async; track collection.id) {
          <mat-option [value]="collection.id">
            {{ collection.name }} (ID: {{ collection.id }})
          </mat-option>
        }
      </mat-select>
    </mat-form-field>
  </div>

  <!-- Main content area -->
  @if (selectedCollectionId) {
    <div class="main-content">
      <!-- Publications panel (left column) -->
      <div class="publications-panel">
        <publication-keyword-table
              [publications$]="publications$"
              [selectedId]="selectedPublicationId"
              [loading]="isLoading"
              (rowClick)="selectPublication($event)"
        ></publication-keyword-table>
      </div>

      <!-- Keywords panel (right column) -->
      @if (selectedPublicationId) {
        @let linkedKeywordsList = (linkedKeywords$ | async) || [];

        <div class="keywords-panel">
          <h3>
            Linked keywords
            @if (linkedKeywordsList.length) {
              ({{ linkedKeywordsList.length }})
            }
          </h3>

          <!-- Keyword search field -->
          <div class="keyword-search-section">
            <mat-form-field class="search-field">
              <mat-label>Link a keyword</mat-label>
              <input matInput
                    [formControl]="keywordSearchControl"
                    [matAutocomplete]="keywordAuto"
                    placeholder="Search keywords by name or create a new one…">
              @if (!(keywordSearchControl.value | isEmptyString)) {
                <button matIconButton
                      matSuffix
                      (click)="keywordSearchControl.setValue('')"
                >
                  <mat-icon>close</mat-icon>
                </button>
              } @else {
                <mat-icon matSuffix>flowchart</mat-icon>
              }
            </mat-form-field>
            
            <mat-autocomplete
                  #keywordAuto="matAutocomplete" 
                  [displayWith]="displayKeyword"
                  (optionSelected)="onKeywordSelected($event)"
            >
              @for (keyword of filteredKeywords$ | async; track keyword.id) {
                <mat-option [value]="keyword">
                  <div class="keyword-option">
                    <mat-icon>link</mat-icon>
                    <span class="k-name">{{ keyword.name }}</span>
                    @if (keyword.category) {
                      <span class="k-category">[{{ keyword.category }}]</span>
                    }
                  </div>
                </mat-option>
              }
              @if (keywordSearchControl.value) {
                <mat-option [value]="null">
                  <div class="create-new-option">
                    <mat-icon>add</mat-icon>
                    Create new keyword: »{{ keywordSearchControl.value }}»
                  </div>
                </mat-option>
              }
            </mat-autocomplete>
          </div>

          <!-- Linked keywords table -->
          @if (!isLoading) {
            <div class="keywords-table">
              <table mat-table [dataSource]="linkedKeywordsList" class="mat-elevation-z1">
                <!-- Keyword name column -->
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Keyword</th>
                  <td mat-cell *matCellDef="let keyword">{{ keyword.name }}</td>
                </ng-container>

                <!-- Category column -->
                <ng-container matColumnDef="category">
                  <th mat-header-cell *matHeaderCellDef>Category</th>
                  <td mat-cell *matCellDef="let keyword">
                      @if (keyword.category) {
                      <span>{{ keyword.category }}</span>
                      }
                  </td>
                </ng-container>

                <!-- Actions column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Actions</th>
                  <td mat-cell *matCellDef="let keyword">
                    <div class="row-actions">
                      <button matIconButton (click)="removeKeywordFromPublication(keyword)">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="keywordColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: keywordColumns"></tr>
              </table>

              @if (!isLoading && hasLoadedOnce && linkedKeywordsList.length === 0) {
                <div class="no-keywords">
                  <mat-icon>label_off</mat-icon>
                  <p>No keywords linked to this publication.</p>
                  <p>Use the search field above to find existing keywords or create new ones.</p>
                </div>
              }
            </div>
          } @else {
            <!-- Loading keywords -->
            <div class="loading">
              <mat-spinner diameter="40"></mat-spinner>
              <p>Loading keywords…</p>
            </div>
          }
        </div>
      } @else {
        <!-- No publication selected -->
        <div class="no-selection">
          <mat-icon>description</mat-icon>
          <p>Select a publication from the list to view and manage its linked keywords.</p>
        </div>
      }
    </div>
  }
}
