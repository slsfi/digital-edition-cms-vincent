<h1>Table of contents management</h1>

@if (projectName === null) {
  <p>Please select a project.</p>
} @else {
  <!-- Collection selection -->
  <div class="collection-selection">
    <mat-form-field [subscriptSizing]="'dynamic'">
      <mat-label>Publication collection</mat-label>
      <mat-select [(value)]="selectedCollection" (selectionChange)="setSelectedCollection($event.value)">
        @for (collection of collections; track collection.id) {
          <mat-option [value]="collection">
            {{ collection.name }} (ID: {{ collection.id }})
          </mat-option>
        }
      </mat-select>
    </mat-form-field>

    <!-- TOC language select (only if a collection is selected) -->
    @if (selectedCollectionId) {
      @let variants = tocVariantsByCollectionId[selectedCollectionId!] || emptyTocVariants;
      @let existingLangs = availableLanguages | existingTocLanguages: variants;
      @let nonExistingLangs = availableLanguages | nonExistingTocLanguages: variants;

      <mat-form-field class="toc-language-select" [subscriptSizing]="'dynamic'">
        <mat-label>Table of contents language</mat-label>
        <mat-select
              [(value)]="tocLanguageSelection"
              (selectionChange)="changeTocLanguage($event.value)"
              canSelectNullableOptions
        >

          <!-- shared reusable group template defined here -->
          <ng-template #languagesWithoutTocGroup>
            <mat-optgroup label="Languages without ToC">
              @if (!variants.hasShared) {
                <mat-option [value]="sharedTocLanguage.code">
                  {{ sharedTocLanguage.label }}
                </mat-option>
              }

              @for (opt of nonExistingLangs; track opt.code) {
                <mat-option [value]="opt.code">
                  {{ opt.label }} ({{ opt.code }})
                </mat-option>
              }
            </mat-optgroup>
          </ng-template>

          <!-- CASE A: At least one existing version (shared or language-specific) -->
          @if (existingLangs.length > 0) {

            <!-- Available ToC versions -->
            <mat-optgroup label="Available ToC versions">
              @for (opt of existingLangs; track opt.code) {
                <mat-option [value]="opt.code">
                  {{ opt.label }}@if (opt.code) { ({{ opt.code }}) }
                </mat-option>
              }
            </mat-optgroup>

            <!-- Other languages (without ToC) -->
            @if (nonExistingLangs.length > 0 || !variants.hasShared) {
              <ng-container *ngTemplateOutlet="languagesWithoutTocGroup"/>
            }

          <!-- CASE B: No existing TOCs at all -->
          } @else {
            <ng-container *ngTemplateOutlet="languagesWithoutTocGroup"/>
          }

        </mat-select>
      </mat-form-field>
    }
  </div>

  <!-- Action buttons -->
  @if (selectedCollectionId) {
    <div class="actions-wrapper">
      <div class="left-aligned">
        <button matButton="filled"
              (click)="openReloadTableOfContentsDialog()"
              [disabled]="isLoading || isUpdatingFromDb || isSaving || isGeneratingFlatToc || (!currentToc && !isLoading)"
        >
          <mat-icon>refresh</mat-icon>
          Reload
        </button>
        <button matButton="filled" (click)="openUpdateNodeFieldsDialog()" 
                [disabled]="!currentToc || isLoading || isUpdatingFromDb || isSaving || isGeneratingFlatToc || hasUnsavedChanges">
          <mat-icon>update</mat-icon>
          Update item fields
        </button>
        <button matButton="filled" (click)="openAutoGenerateDialog()" 
                [disabled]="isLoading || isUpdatingFromDb || isSaving || isGeneratingFlatToc">
          <mat-icon>auto_awesome</mat-icon>
          Generate
        </button>
        <button matButton="filled" (click)="newTableOfContents()" 
                [disabled]="isLoading || isUpdatingFromDb || isSaving || isGeneratingFlatToc">
          <mat-icon>clear_all</mat-icon>
          New
        </button>
      </div>

      <div class="right-aligned">
        @if (isLoading || isSaving || isUpdatingFromDb || isGeneratingFlatToc) {
          <div class="status-item progress-activity">
            <mat-icon class="spin">progress_activity</mat-icon>
            <span>
              @if (isLoading) {
                Loading…
              } @else if (isSaving) {
                Saving…
              } @else if (isUpdatingFromDb) {
                Updating…
              } @else if (isGeneratingFlatToc) {
                Generating…
              }
            </span>
          </div>
        } @else if (hasUnsavedChanges) {
          <div class="status-item unsaved-changes">
            <mat-icon>warning</mat-icon>
            <span>Unsaved changes</span>
          </div>
        } @else if (currentToc) {
          <div class="status-item all-saved">
            <mat-icon>check_circle</mat-icon>
            <span>All changes saved</span>
          </div>
        }
        <button matButton="filled" (click)="saveTableOfContents()" 
                [disabled]="!currentToc || isLoading || isUpdatingFromDb || isSaving || isGeneratingFlatToc || !hasUnsavedChanges">
          <mat-icon>upload</mat-icon>
          Save
        </button>
      </div>
    </div>
  }

  <!-- Loading spinner -->
  @if (isLoading) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Loading table of contents…</p>
    </div>
  }

  <!-- Table of contents tree -->
  @if (currentToc && !isLoading) {
    <div class="toc-tree-container">
      <h2>Table of contents – {{selectedCollection?.name}} (ID: {{selectedCollection?.id}})</h2>
      <toc-tree 
        [toc]="currentToc" 
        [collectionId]="selectedCollectionId!"
        [publications]="publicationsForSelectedCollection"
        (tocChanged)="markTocAsChanged()">
      </toc-tree>
    </div>
  }

  <!-- Empty State -->
  @if (selectedCollectionId && !currentToc && !isLoading) {
    <div class="empty-state">
      <mat-icon>folder_open</mat-icon>
      <h3>No table of contents</h3>
      @if (currentTocLanguage) {
        <p>This collection doesn’t have a table of contents<br>
        in {{ currentTocLanguage | getLangLabel }} ({{ currentTocLanguage }}) yet,<br>
        or an error prevented it from being loaded.</p>
      } @else {
        <p>This collection doesn’t have a shared table of contents<br>
        for all languages yet,<br>
        or an error prevented it from being loaded.</p>
      }
    </div>
  }
}
