<div [class]="getNodeClass()" cdkDrag>
  <!-- Drag handle -->
  <div class="drag-handle" cdkDragHandle>
    <mat-icon>drag_indicator</mat-icon>
  </div>

  <!-- Node Content -->
  <div class="node-content">
    <!-- Display Mode -->
    @if (!isEditing) {
    <div class="display-mode">
      <div class="text-content">
        <div class="node-text">{{ node.text }}</div>
        
        <!-- Text Node Info - Simplified -->
        @if (isTextNode && (node.date || node.itemId)) {
        <div class="text-node-info">
          @if (node.date) { <span class="date">{{ node.date }}</span> }
          @if (node.itemId) { <span class="item-id">ID: {{ node.itemId }}</span> }
        </div>
        }
      </div>

      <!-- Node Actions - Right aligned collapse menu -->
      <div class="node-actions">
        @if (isSubtitle) {
        <button mat-icon-button 
                (click)="onToggleCollapse()"
                [matTooltip]="isCollapsed ? 'Expand' : 'Collapse'">
          <mat-icon>{{ isCollapsed ? 'expand_more' : 'expand_less' }}</mat-icon>
        </button>
        }

        <button mat-icon-button 
                [matMenuTriggerFor]="nodeMenu"
                matTooltip="Node actions">
          <mat-icon>more_vert</mat-icon>
        </button>

        <mat-menu #nodeMenu="matMenu">
          <button mat-menu-item (click)="onEdit()">
            <mat-icon>edit</mat-icon>
            <span>Edit</span>
          </button>
          <button mat-menu-item (click)="onAddChild()">
            <mat-icon>add</mat-icon>
            <span>Add child</span>
          </button>
          <button mat-menu-item (click)="onDelete()" class="delete-action">
            <mat-icon>delete</mat-icon>
            <span>Delete</span>
          </button>
        </mat-menu>
      </div>
    </div>
    }

    <!-- Edit Mode -->
    @if (isEditing) {
    <div class="edit-mode">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Text</mat-label>
        <input matInput [(ngModel)]="editText" placeholder="Enter text">
      </mat-form-field>

      <!-- Text Node Specific Fields -->
      @if (isTextNode) {
      <div class="text-node-fields">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Date</mat-label>
          <input matInput [(ngModel)]="editDate" placeholder="YYYY-MM-DD">
        </mat-form-field>

        <!-- Publication Selection -->
        <div class="publication-selection-edit">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Link to Publication</mat-label>
            <mat-select [(value)]="selectedPublication" (selectionChange)="onPublicationSelected($event.value)">
              <mat-option [value]="null">No publication linked</mat-option>
              @for (pub of publications; track pub.id) {
                <mat-option [value]="pub">
                  {{ pub.name }} (ID: {{ pub.id }})
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
      </div>
      }

      <!-- Edit Actions -->
      <div class="edit-actions">
        <button mat-button (click)="onCancel()">Cancel</button>
        <button mat-raised-button color="primary" (click)="onSave()">Save</button>
      </div>
    </div>
    }
  </div>


  <!-- Children (for subtitle nodes) -->
  @if (isSubtitle && !isCollapsed && node.children && node.children.length > 0) {
  <div 
       class="children-container"
       cdkDropList
       [cdkDropListData]="node.children"
       (cdkDropListDropped)="onChildDrop($event)">
    
    @for (child of node.children; track child.id || $index; let i = $index) {
    <app-toc-node 
      [node]="child" 
      [nodePath]="getChildNodePath(i)"
      [collectionId]="collectionId"
      [depth]="depth + 1"
      (nodeChanged)="nodeChanged.emit()"
      (deleteNode)="deleteNode.emit($event)"
      (addChildNode)="addChildNode.emit($event)">
    </app-toc-node>
    }
  </div>
  }
</div>
