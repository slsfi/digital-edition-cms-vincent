<div class="toc-tree">
  <!-- ToC root properties -->
  <div class="toc-root">
    <div class="root-properties">
      <div class="toc-title">{{ toc.text }}</div>
      @if (toc.coverPageName || toc.titlePageName || toc.forewordPageName || toc.introductionPageName) {
        <div class="frontmatter-page-name-wrapper">
          @if (toc.coverPageName) {
            <div class="frontmatter-page-name">
              <span class="root-label">Cover page name: </span><span class="fm-name">{{ toc.coverPageName }}</span>
            </div>
          }
          @if (toc.titlePageName) {
            <div class="frontmatter-page-name">
              <span class="root-label">Title page name: </span><span class="fm-name">{{ toc.titlePageName }}</span>
            </div>
          }
          @if (toc.forewordPageName) {
            <div class="frontmatter-page-name">
              <span class="root-label">Foreword page name: </span><span class="fm-name">{{ toc.forewordPageName }}</span>
            </div>
          }
          @if (toc.introductionPageName) {
            <div class="frontmatter-page-name">
              <span class="root-label">Introduction page name: </span><span class="fm-name">{{ toc.introductionPageName }}</span>
            </div>
          }
        </div>
      }
    </div>
    <div class="root-actions">
      <button mat-icon-button 
              (click)="editTocRootProperties()"
              matTooltip="Edit base properties"
              [attr.aria-label]="'Edit base properties'"
      >
        <mat-icon>edit</mat-icon>
      </button>
      <button mat-icon-button 
              (click)="collapseAll()"
              matTooltip="Collapse all nodes"
              [attr.aria-label]="'Collapse all nodes'"
      >
        <mat-icon>collapse_all</mat-icon>
      </button>
      <button mat-icon-button 
              (click)="expandAll()"
              matTooltip="Expand all nodes"
              [attr.aria-label]="'Expand all nodes'"
      >
        <mat-icon>expand_all</mat-icon>
      </button>
    </div>
  </div>
  
  <div cdkDropList 
       [cdkDropListData]="toc.children"
       [id]="'main'" 
       [cdkDropListConnectedTo]="getAllDropListIds()"
       (cdkDropListDropped)="drop($event)"
       [cdkDropListSortingDisabled]="true"
  >
    @for (node of toc.children; track node.id) {
      <div cdkDrag 
           [cdkDragData]="node.id"      
           (cdkDragMoved)="dragMoved($event)"
      >
        <ng-container *ngTemplateOutlet="tmplNode; context: {node: node}"/>
      </div>
    }
  </div>

  <!-- Add root level node button -->
  <div class="add-root-button-wrapper">
    <button matButton="outlined" (click)="addChildNode()">
      <mat-icon>add</mat-icon>
      Add node
    </button>
  </div>
</div>

<!-- Template for each node -->
<ng-template #tmplNode let-node="node">
  <div class="node-item" [attr.id]="node.id">
    <div class="node-header">
      @if (node.type === 'section') {
        <button class="expand-button"
                [disabled]="!node.children.length" 
                (click)="toggleNodeExpansion(node)"
                tabindex="0"
                role="button"
                [attr.aria-expanded]="(!!node.children?.length && !!node.isExpanded) ? 'true' : 'false'"
                [attr.aria-label]="'Toggle expansion for section node'"
        >
          <mat-icon>{{node.isExpanded && node.children.length ? 'expand_less' : 'expand_more'}}</mat-icon>
        </button>
      }
      
      <div class="node-content-text" 
            [class.no-expand]="node.type === 'text'"
      >
        <div class="node-text">{{node.text}}</div>
        @if (node.itemId || node.description) {
          <div class="node-meta">
            @if (node.description) {
              <div class="node-description">
                {{node.description}}
              </div>
            }
            @if (node.itemId) {
              <!-- text nodes always have itemId and section nodes
               may have it, so enough to check for its presence -->
              <div class="meta-items">
                @if (node.itemId) {
                  <span class="meta-item item-id">
                    <mat-icon class="meta-icon">link</mat-icon>
                    {{node.itemId}}
                  </span>
                }
                @if (node.date) {
                  <span class="meta-item date">
                    <mat-icon class="meta-icon">event</mat-icon>
                    {{node.date}}
                  </span>
                }
                @if (node.category) {
                  <span class="meta-item category">
                    <mat-icon class="meta-icon">category</mat-icon>
                    {{node.category}}
                  </span>
                }
                @if (node.facsimileOnly) {
                  <span class="meta-item facsimile">
                    <mat-icon class="meta-icon">image</mat-icon>
                    Facsimile only
                  </span>
                }
              </div>
            }
          </div>
        }
      </div>
      
      <div class="node-actions">
        <!-- Edit button (most used) -->
        <button mat-icon-button 
                (click)="editNode(node)"
                matTooltip="Edit node properties"
                [attr.aria-label]="'Edit node properties'"
        >
          <mat-icon>edit</mat-icon>
        </button>
        
        <!-- Up/Down movement buttons -->
        <button mat-icon-button 
                (click)="moveNodeUp(node)"
                [disabled]="!(node.path | canMoveNodeUp)"
                matTooltip="Move node up"
                [attr.aria-label]="'Move node up'"
        >
          <mat-icon>arrow_upward_alt</mat-icon>
        </button>
        
        <button mat-icon-button 
                (click)="moveNodeDown(node)"
                [disabled]="!(toc | canMoveNodeDown: node.path)"
                matTooltip="Move node down"
                [attr.aria-label]="'Move node down'"
        >
          <mat-icon>arrow_downward_alt</mat-icon>
        </button>
        
        <!-- Three-dot menu for other actions -->
        <button mat-icon-button 
                [matMenuTriggerFor]="nodeMenu"
                class="menu-trigger"
                matTooltip="Additional node actions"
                [attr.aria-label]="'Additional node actions'"
        >
          <mat-icon>more_vert</mat-icon>
        </button>
        
        <mat-menu #nodeMenu="matMenu">
          @if (node.type === 'section') {
            <button mat-menu-item (click)="addChildNode(node)">
              <mat-icon>add</mat-icon>
              <span>Add child</span>
            </button>
          }
          <button mat-menu-item (click)="addSiblingNode(node)">
            <mat-icon>add</mat-icon>
            <span>Add sibling</span>
          </button>
          <button mat-menu-item (click)="deleteNode(node)" class="delete-action">
            <mat-icon>delete</mat-icon>
            <span>Delete</span>
          </button>
        </mat-menu>
      </div>
    </div>

    @if (node.isExpanded && node.children && node.children.length) {
      <div class="node-children"
           cdkDropList 
           [cdkDropListData]="node.children"
           [id]="node.id" 
           [cdkDropListConnectedTo]="getAllDropListIds()"
           (cdkDropListDropped)="drop($event)"
           [cdkDropListSortingDisabled]="true"
      >
        @for (child of node.children; track child.id) {
          <div cdkDrag 
               [cdkDragData]="child.id" 
               (cdkDragMoved)="dragMoved($event)"
          >
            <ng-container *ngTemplateOutlet="tmplNode; context: {node: child}"/>  
          </div>
        }
      </div>
    }
  </div>
</ng-template>
